import*as e from"postcss";import*as t from"postcss-selector-parser";var r="default"in e?e.default:e;var l="default"in t?t.default:t;var o={};const{Rule:n,AtRule:s}=r;let a=l;function parse(e,t){let r;try{a((e=>{r=e})).processSync(e)}catch(r){throw e.includes(":")?t?t.error("Missed semicolon"):r:t?t.error(r.message):r}return r.at(0)}function interpolateAmpInSelector(e,t){let r=false;e.each((e=>{if("nesting"===e.type){let l=t.clone({});"&"!==e.value?e.replaceWith(parse(e.value.replace("&",l.toString()))):e.replaceWith(l);r=true}else"nodes"in e&&e.nodes&&interpolateAmpInSelector(e,t)&&(r=true)}));return r}function mergeSelectors(e,t){let r=[];e.selectors.forEach((l=>{let o=parse(l,e);t.selectors.forEach((e=>{if(!e)return;let l=parse(e,t);let n=interpolateAmpInSelector(l,o);if(!n){l.prepend(a.combinator({value:" "}));l.prepend(o.clone({}))}r.push(l.toString())}))}));return r}function breakOut(e,t){let r=e.prev();t.after(e);while(r&&"comment"===r.type){let e=r.prev();t.after(r);r=e}return e}function createFnAtruleChilds(e){return function atruleChilds(t,r,l,o=l){let n=[];r.each((s=>{"rule"===s.type&&l?o&&(s.selectors=mergeSelectors(t,s)):"atrule"===s.type&&s.nodes?e[s.name]?atruleChilds(t,s,o):false!==r[u]&&n.push(s):n.push(s)}));if(l&&n.length){let e=t.clone({nodes:[]});for(let t of n)e.append(t);r.prepend(e)}}}function pickDeclarations(e,t,r){let l=new n({selector:e,nodes:[]});l.append(t);r.after(l);return l}function atruleNames(e,t){let r={};for(let t of e)r[t]=true;if(t)for(let e of t)r[e.replace(/^@/,"")]=true;return r}function parseRootRuleParams(e){e=e.trim();let t=e.match(/^\((.*)\)$/);if(!t)return{type:"basic",selector:e};let r=t[1].match(/^(with(?:out)?):(.+)$/);if(r){let e="with"===r[1];let t=Object.fromEntries(r[2].trim().split(/\s+/).map((e=>[e,true])));if(e&&t.all)return{type:"noop"};let escapes=e=>!!t[e];t.all?escapes=()=>true:e&&(escapes=e=>"all"!==e&&!t[e]);return{type:"withrules",escapes:escapes}}return{type:"unknown"}}function getAncestorRules(e){let t=[];let r=e.parent;while(r&&r instanceof s){t.push(r);r=r.parent}return t}function unwrapRootRule(e){let t=e[c];if(t){let r=e.nodes;let l;let o=-1;let n;let s;let a;let u=getAncestorRules(e);u.forEach(((e,r)=>{if(t(e.name)){l=e;o=r;s=a}else{let t=a;a=e.clone({nodes:[]});t&&a.append(t);n=n||a}}));if(l)if(s){let e=n;e.append(r);l.after(s)}else l.after(r);else e.after(r);if(e.next()&&l){let t;u.slice(0,o+1).forEach(((r,l,o)=>{let n=t;t=r.clone({nodes:[]});n&&t.append(n);let s=[];let a=o[l-1]||e;let u=a.next();while(u){s.push(u);u=u.next()}t.append(s)}));t&&(s||r[r.length-1]).after(t)}}else e.after(e.nodes);e.remove()}const u=Symbol("rootRuleMergeSel");const c=Symbol("rootRuleEscapes");function normalizeRootRule(e){let{params:t}=e;let{type:r,selector:l,escapes:o}=parseRootRuleParams(t);if("unknown"===r)throw e.error(`Unknown @${e.name} parameter ${JSON.stringify(t)}`);if("basic"===r&&l){let t=new n({selector:l,nodes:e.nodes});e.removeAll();e.append(t)}e[c]=o;e[u]=o?!o("all"):"noop"===r}const p=Symbol("hasRootRule");o=(e={})=>{let t=atruleNames(["media","supports","layer","container"],e.bubble);let r=createFnAtruleChilds(t);let l=atruleNames(["document","font-face","keyframes","-webkit-keyframes","-moz-keyframes"],e.unwrap);let o=(e.rootRuleName||"at-root").replace(/^@/,"");let n=e.preserveEmpty;return{postcssPlugin:"postcss-nested",Once(e){e.walkAtRules(o,(t=>{normalizeRootRule(t);e[p]=true}))},Rule(e){let s=false;let a=e;let c=false;let p=[];e.each((n=>{if("rule"===n.type){if(p.length){a=pickDeclarations(e.selector,p,a);p=[]}c=true;s=true;n.selectors=mergeSelectors(e,n);a=breakOut(n,a)}else if("atrule"===n.type){if(p.length){a=pickDeclarations(e.selector,p,a);p=[]}if(n.name===o){s=true;r(e,n,true,n[u]);a=breakOut(n,a)}else if(t[n.name]){c=true;s=true;r(e,n,true);a=breakOut(n,a)}else if(l[n.name]){c=true;s=true;r(e,n,false);a=breakOut(n,a)}else c&&p.push(n)}else"decl"===n.type&&c&&p.push(n)}));p.length&&(a=pickDeclarations(e.selector,p,a));if(s&&true!==n){e.raws.semicolon=true;0===e.nodes.length&&e.remove()}},RootExit(e){if(e[p]){e.walkAtRules(o,unwrapRootRule);e[p]=false}}}};o.postcss=true;var i=o;const f=o.postcss;export{i as default,f as postcss};

