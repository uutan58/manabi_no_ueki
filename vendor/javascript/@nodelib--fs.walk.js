import*as t from"events";import*as e from"@nodelib/fs.scandir";import*as r from"fastq";import s from"process";import*as i from"stream";import*as a from"path";var n={};Object.defineProperty(n,"__esModule",{value:true});n.joinPathSegments=n.replacePathSegmentSeparator=n.isAppliedFilter=n.isFatalError=void 0;function isFatalError(t,e){return null===t.errorFilter||!t.errorFilter(e)}n.isFatalError=isFatalError;function isAppliedFilter(t,e){return null===t||t(e)}n.isAppliedFilter=isAppliedFilter;function replacePathSegmentSeparator(t,e){return t.split(/[/\\]/).join(e)}n.replacePathSegmentSeparator=replacePathSegmentSeparator;function joinPathSegments(t,e,r){return""===t?e:t.endsWith(r)?t+e:t+r+e}n.joinPathSegments=joinPathSegments;var o={};Object.defineProperty(o,"__esModule",{value:true});const l=n;class Reader{constructor(t,e){this._root=t;this._settings=e;this._root=l.replacePathSegmentSeparator(t,e.pathSegmentSeparator)}}o.default=Reader;var h="default"in t?t.default:t;var d="default"in e?e.default:e;var u="default"in r?r.default:r;var _={};var c=s;Object.defineProperty(_,"__esModule",{value:true});const p=h;const f=d;const S=u;const g=n;const y=o;class AsyncReader extends y.default{constructor(t,e){super(t,e);this._settings=e;this._scandir=f.scandir;this._emitter=new p.EventEmitter;this._queue=S(this._worker.bind(this),this._settings.concurrency);this._isFatalError=false;this._isDestroyed=false;this._queue.drain=()=>{this._isFatalError||this._emitter.emit("end")}}read(){this._isFatalError=false;this._isDestroyed=false;c.nextTick((()=>{this._pushToQueue(this._root,this._settings.basePath)}));return this._emitter}get isDestroyed(){return this._isDestroyed}destroy(){if(this._isDestroyed)throw new Error("The reader is already destroyed");this._isDestroyed=true;this._queue.killAndDrain()}onEntry(t){this._emitter.on("entry",t)}onError(t){this._emitter.once("error",t)}onEnd(t){this._emitter.once("end",t)}_pushToQueue(t,e){const r={directory:t,base:e};this._queue.push(r,(t=>{null!==t&&this._handleError(t)}))}_worker(t,e){this._scandir(t.directory,this._settings.fsScandirSettings,((r,s)=>{if(null===r){for(const e of s)this._handleEntry(e,t.base);e(null,void 0)}else e(r,void 0)}))}_handleError(t){if(!this._isDestroyed&&g.isFatalError(this._settings,t)){this._isFatalError=true;this._isDestroyed=true;this._emitter.emit("error",t)}}_handleEntry(t,e){if(this._isDestroyed||this._isFatalError)return;const r=t.path;void 0!==e&&(t.path=g.joinPathSegments(e,t.name,this._settings.pathSegmentSeparator));g.isAppliedFilter(this._settings.entryFilter,t)&&this._emitEntry(t);t.dirent.isDirectory()&&g.isAppliedFilter(this._settings.deepFilter,t)&&this._pushToQueue(r,void 0===e?void 0:t.path)}_emitEntry(t){this._emitter.emit("entry",t)}}_.default=AsyncReader;var m={};Object.defineProperty(m,"__esModule",{value:true});const v=_;class AsyncProvider{constructor(t,e){this._root=t;this._settings=e;this._reader=new v.default(this._root,this._settings);this._storage=[]}read(t){this._reader.onError((e=>{callFailureCallback(t,e)}));this._reader.onEntry((t=>{this._storage.push(t)}));this._reader.onEnd((()=>{callSuccessCallback(t,this._storage)}));this._reader.read()}}m.default=AsyncProvider;function callFailureCallback(t,e){t(e)}function callSuccessCallback(t,e){t(null,e)}var w="default"in i?i.default:i;var E={};Object.defineProperty(E,"__esModule",{value:true});const F=w;const k=_;class StreamProvider{constructor(t,e){this._root=t;this._settings=e;this._reader=new k.default(this._root,this._settings);this._stream=new F.Readable({objectMode:true,read:()=>{},destroy:()=>{this._reader.isDestroyed||this._reader.destroy()}})}read(){this._reader.onError((t=>{this._stream.emit("error",t)}));this._reader.onEntry((t=>{this._stream.push(t)}));this._reader.onEnd((()=>{this._stream.push(null)}));this._reader.read();return this._stream}}E.default=StreamProvider;var P="default"in e?e.default:e;var b={};Object.defineProperty(b,"__esModule",{value:true});const j=P;const D=n;const A=o;class SyncReader extends A.default{constructor(){super(...arguments);this._scandir=j.scandirSync;this._storage=[];this._queue=new Set}read(){this._pushToQueue(this._root,this._settings.basePath);this._handleQueue();return this._storage}_pushToQueue(t,e){this._queue.add({directory:t,base:e})}_handleQueue(){for(const t of this._queue.values())this._handleDirectory(t.directory,t.base)}_handleDirectory(t,e){try{const r=this._scandir(t,this._settings.fsScandirSettings);for(const t of r)this._handleEntry(t,e)}catch(t){this._handleError(t)}}_handleError(t){if(D.isFatalError(this._settings,t))throw t}_handleEntry(t,e){const r=t.path;void 0!==e&&(t.path=D.joinPathSegments(e,t.name,this._settings.pathSegmentSeparator));D.isAppliedFilter(this._settings.entryFilter,t)&&this._pushToStorage(t);t.dirent.isDirectory()&&D.isAppliedFilter(this._settings.deepFilter,t)&&this._pushToQueue(r,void 0===e?void 0:t.path)}_pushToStorage(t){this._storage.push(t)}}b.default=SyncReader;var O={};Object.defineProperty(O,"__esModule",{value:true});const T=b;class SyncProvider{constructor(t,e){this._root=t;this._settings=e;this._reader=new T.default(this._root,this._settings)}read(){return this._reader.read()}}O.default=SyncProvider;var M="default"in a?a.default:a;var q="default"in e?e.default:e;var Q={};Object.defineProperty(Q,"__esModule",{value:true});const V=M;const R=q;class Settings$1{constructor(t={}){this._options=t;this.basePath=this._getValue(this._options.basePath,void 0);this.concurrency=this._getValue(this._options.concurrency,Number.POSITIVE_INFINITY);this.deepFilter=this._getValue(this._options.deepFilter,null);this.entryFilter=this._getValue(this._options.entryFilter,null);this.errorFilter=this._getValue(this._options.errorFilter,null);this.pathSegmentSeparator=this._getValue(this._options.pathSegmentSeparator,V.sep);this.fsScandirSettings=new R.Settings({followSymbolicLinks:this._options.followSymbolicLinks,fs:this._options.fs,pathSegmentSeparator:this._options.pathSegmentSeparator,stats:this._options.stats,throwErrorOnBrokenSymbolicLink:this._options.throwErrorOnBrokenSymbolicLink})}_getValue(t,e){return null!==t&&void 0!==t?t:e}}Q.default=Settings$1;var x={};Object.defineProperty(x,"__esModule",{value:true});x.Settings=x.walkStream=x.walkSync=x.walk=void 0;const I=m;const C=E;const L=O;const N=Q;x.Settings=N.default;function walk(t,e,r){"function"!==typeof e?new I.default(t,getSettings(e)).read(r):new I.default(t,getSettings()).read(e)}x.walk=walk;function walkSync(t,e){const r=getSettings(e);const s=new L.default(t,r);return s.read()}x.walkSync=walkSync;function walkStream(t,e){const r=getSettings(e);const s=new C.default(t,r);return s.read()}x.walkStream=walkStream;function getSettings(t={}){return t instanceof N.default?t:new N.default(t)}const B=x.__esModule,$=x.Settings;const W=x.walkStream,Y=x.walkSync,z=x.walk;export default x;export{$ as Settings,B as __esModule,z as walk,W as walkStream,Y as walkSync};

